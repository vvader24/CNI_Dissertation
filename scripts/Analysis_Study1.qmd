---
title: "Cultural Normativity Index: Study 1"
format: 
  pdf:
    prefer-html: true
    mainfont: Times
    mainfontoptions: 
       - Numbers=OldStyle
       - Ligatures=TeX
    monofontoptions: Scale=0.9 
    fontsize: 11.2pt
    code-block-font-size: 9pt
    toc: true
    number-sections: true
    number-depth: 3
    section-divs: true
    toc-depth: 3
    secnumdepth: 3
    lof: true
    lot: true
    lof-title: "List of Figures"
    execute:
       warning: false
       message: false
    code-block-wrap: true
    code-overflow: wrap
    include-in-header: 
      text: |
         \usepackage[T1]{fontenc}
    documentclass: article
    geometry: margin=1in
    papersize: letter
    keep-tex: true
    crossref:
      fig-prefix: "Figure"
      lof-title: "List of Figures"
    extra_dependencies: ["pdflscape", "booktabs", "longtable"]
editor: source
---

# Data

## Libraries

```{r Libraries}
pacman::p_load(tidyverse, dplyr, rio, expss, scales, glue,
               rlang, kableExtra, stringr, tibble, psych, here, webshot2,
              lavaan,semTools,#Measurement Invariance
               haven, parallel, tictoc, papaja, #wrangling and setup
               patchwork,gridExtra, ggplot2, grid, ggtext, tools, #plots
               lme4, lmerTest, broom.mixed, tidyr, #modeling - mlm
               emmeans, marginaleffects, modelsummary, 
               pbkrtest, car #model estimates
               )  
 
options(modelsummary_get = "easystats")
```


## Data import and set up
The data, originally in the .sav format, is identified by labels for each set of items. Scale scores for individual and community (here, country) level are computed for each measure. 

```{r data1}
#Study1 = data1
all_data1 <- import(here::here("data", "mcvs8_2839mv3ssvsrm2partlyreduced.sav"), setclass = "tibble")

#This ensures that the items are correctly classified within their respective  domains
all_vars_d <- tibble(all_vars = names(all_data1)) %>%
    mutate(
    domain = case_when(
      str_starts(all_vars, "ism") ~ "Isms",
      str_starts(all_vars, "f_") ~ "Fanaticism",
      str_detect(all_vars, "^ssvs\\d{1,2}$") ~ "Values",
      str_starts(all_vars, "sc_p") ~ "Personality_scale",
      str_starts(all_vars, "p_") ~ "Personality6",
      str_starts(all_vars, "d_") ~ "Personality7",
      str_starts(all_vars, "sacy") ~ "Social_Axioms",
      str_starts(all_vars, "swb") ~ "SWB",
      str_starts(all_vars, "g1|g2") ~ "Globe",
      str_starts(all_vars, "fsp") ~ "Failed_state_perception",
      TRUE ~ all_vars
    ))


#func for fanaticsim [naming of items was needed]
get_fntc_items <- function(item.code1, item.code2 = NULL) {
  
  all_fantc_items <- all_vars_d %>% 
    filter(domain == "Fanaticism") %>% 
    mutate(
      rev_scoring = case_when(
        all_vars %in% c("f_gc22", "f_gc24","f_gc32", "f_gk48", 
                        "f_ls54",  "f_gc56", "f_gc57","f_ls60", "f_gk66", "f_ls66",
                        "f_gc69", "f_gc72", "f_gc80","f_gc81", "f_gk85", "f_gk92",
                        "f_gk93", "f_ls98", "f_ls100", "f_ls109") ~ "rev",
        TRUE ~ "pos"
      ),
      subscale = case_when(
        all_vars %in% c("f_gc89", "f_gc4", "f_gk111", "f_gc27", 
                        "f_gk20", "f_gc68") ~ "vile_world",
        all_vars %in% c("f_gc69", "f_ls22", "f_gk48" ,"f_ls95", 
                        "f_gk88", "f_gk44", "f_gk82", "f_ls125", "f_ls56",
                        "f_gc56") ~ "proviolence",
        all_vars %in% c("f_gc72", "f_gc47", "f_gk92", "f_ls107", "f_gk67", "f_gc57", "f_gc17") ~ "divine_power",
        TRUE ~ NA_character_ 
      ),
      theme = case_when(
        str_detect(all_vars, "ls") ~ "islam_extrm",
        str_detect(all_vars, "gk") ~ "yug_extrm",
        str_detect(all_vars, "gc") ~ "pan_extrm",
        TRUE ~ NA_character_  
      )
    ) %>% 
    mutate(code = paste0(theme,".", subscale, ".",rev_scoring)) %>% 
    select(all_vars, code)
  
  # Filter based on one or two patterns
  if (is.null(item.code2)) {
    items <- all_fantc_items %>%
      filter(str_detect(code, item.code1)) %>%
      pull(all_vars)
  } else {
    items <- all_fantc_items %>%
      filter(str_detect(code, item.code1) & str_detect(code, item.code2)) %>%
      pull(all_vars)
  }
  
  return(items)
}

#get all item numbers for each domain
item_names <- \(domain_name){
  all_item_names <- all_vars_d %>% 
  filter(domain == {{domain_name}}) %>% 
  pull(all_vars)
  return(all_item_names)
}


compute_trait_score <- function(data, pos_items, rev_items = NULL) {
  if (is.null(rev_items)) {
    # If no reverse items are specified, just sum the positive items
    return(rowSums(data %>% select(all_of(pos_items)), na.rm = TRUE))
  } else {
    # If both positive and reverse items are specified
    rowSums(
      data %>% 
        select(all_of(c(pos_items, rev_items))) %>%
      #here the items are assumed to be on the scale of 1 to 5;
      #this function is only applied after ensuring that all items are
      #are measured on or a rescaled to 1to5 
        mutate(across(all_of(rev_items), ~ 6 - .x)),
      na.rm = TRUE
    )
  }
}


data1 <- all_data1 %>% 
  select(
    list_c(map(c("Isms","Globe", "Values", "Fanaticism", "Social_Axioms", "Failed_state_perception","Personality6",
                 "Personality7", "SWB"),
               item_names)), NATION9, age, genderml) %>% # nrow() = 2839
  # Retain rows where data for all five SWB items is present
  filter(if_all(item_names("SWB"), ~!is.na(.)))%>% # nrow() = 2815; 24 rows dropped
 #Removed Belarus data = 4
  filter(!NATION9 == 4) %>% 
  mutate(country = as.character(NATION9),
         genderml = as.character(genderml)) %>% 
   mutate(country= fct_recode(as.character(country),
           "USA"= "1",
           "Slovakia"= "3",
           "Serbia" = "2",
           "Chile" = "5",
           "Guatemala" = "6",
           "Malaysia" = "7", 
           "China" = "9", 
           "Korea"= "8"),
          gender = fct_recode(genderml,
           "female" = "0", "male" = "1"))%>% 
# Rescale all the Values and swb items to a range between 1 to 5
  mutate(across(c(all_of(item_names("Values")), all_of(item_names("SWB"))),
                ~scales::rescale(., to = c(1, 5)))) %>%
        select(-c(NATION9, genderml)) %>% 
  
      #---PERSONALITY MODERATORs---#
       #scP = scale Personality scores
  mutate(
    # Moderators - based on raw data for individuals
         #--Subjective Well-being 
             #compute_trait_score(data, pos_items, rev_items)         #sc - scale scores; scP = scale Personality scores
         sc_swb.indv = compute_trait_score(., item_names("SWB")),
         #--Personality
         scP_Consc.indv = compute_trait_score(., 
            c("p_01c1", "p_19c4"),   c("p_07c2", "p_13c3")),
         scP_Res.indv = compute_trait_score(., 
            c("p_08r2", "p_14r3"),   c("p_02r1", "p_20r4")),
         scP_Hon.indv = compute_trait_score(.,
            c("p_03h1", "p_09h2",   "p_21h4"), c("p_15h3", "p_25h5")),
         scP_Vir.indv = compute_trait_score(.,
            c("p_10v2", "p_16v3"),   c("p_04v1", "p_22v4")),
         scP_Agree.indv = compute_trait_score(., 
            c("p_23a4", "p_05a1"),   c("p_17a3", "p_11a2")),
         scP_Extra.indv = compute_trait_score(., 
            c("p_12e2", "p_18e3"),   c("p_06e1", "p_24e4")),
         #--Personality + Psychopathology(pp) 
         #(also argued to be a pty measure) 
         scP_Dis.indv =  compute_trait_score(., paste0("d_", 1:10))#Disintegration
  ) %>%

   #---MINDSET MODERATOR---#
      #scM = scale Mindset scores
  mutate(
            #compute_trait_score(data, pos_items, rev_items) 
         #Isms
           #alpha = Tradition-oriented Religiousness
         scM_ism_alpha.indv = compute_trait_score(., 
            str_subset(item_names("Isms"),"^ism_a.*(?<!r)$"),  
            str_subset(item_names("Isms"), "^ism_a.+r$") 
           ),  
             
          # beta = Unmitigated Self-Interest
         scM_ism_beta.indv = compute_trait_score(., 
            str_subset(item_names("Isms"),"^ism_b.*(?<!r)$"), #(e.g., "ism_b1") 
            str_subset(item_names("Isms"), "^ism_b.+r$") #(e.g., "ism_b4r")
           ), 
             #gamma = Communal Rationalism
         scM_ism_gamma.indv = compute_trait_score(., 
            str_subset(item_names("Isms"),"^ism_g.*(?<!r)$"),  
            str_subset(item_names("Isms"), "^ism_g.+r$") 
           ),
            #delta = Inequality-Aversion
         scM_ism_delta.indv = compute_trait_score(., 
            str_subset(item_names("Isms"),"^ism_d.*(?<!r)$"),  
            str_subset(item_names("Isms"), "^ism_d.+r$") 
           ),

        #Globe  
          #traditional family structure
        scM_globe_tr.indv = compute_trait_score(.,
            str_subset(item_names("Globe"), "^g.*tr.*$")),
         #uncertainty avoidance
        scM_globe_un.indv = compute_trait_score(.,
            str_subset(item_names("Globe"), "^g.*un.*$")),
         #achievement orientation
        scM_globe_ac.indv = compute_trait_score(.,
            str_subset(item_names("Globe"), "^g.*ac.*$")),
         #assertiveness
        scM_globe_asrt.indv = compute_trait_score(.,
            str_subset(item_names("Globe"), "^g.*ag.*$")),
         #humane
        scM_globe_hu.indv = compute_trait_score(.,
            str_subset(item_names("Globe"), "^g.*hu.*$")),
        #masculinity
        scM_globe_ma.indv = compute_trait_score(.,
            str_subset(item_names("Globe"), "^g.*ma.*$")[-3],
            str_subset(item_names("Globe"), "^g.*ma.*$")[3]),
         #InGroupCollectivism
        scM_globe_gc.indv = compute_trait_score(.,
            str_subset(item_names("Globe"), "^g.*in.*$")),
         #power distance
        scM_globe_po.indv = compute_trait_score(.,
            str_subset(item_names("Globe"), "^g.*po.*$")), 
         #future orientation
        scM_globe_fu.indv = compute_trait_score(.,
            str_subset(item_names("Globe"), "^g.*fu.*$")[-c(3,4)], str_subset(item_names("Globe"), "^g.*fu.*$")[c(3,4)]), 
        
       #Fanaticism
        scM_fntc.indv = compute_trait_score(.,
            get_fntc_items("pos"), get_fntc_items("rev")),
          # yugoslavian extremism
          scM_fntcYug.indv = compute_trait_score(.,
            get_fntc_items("yug_extrm", "pos"),
             get_fntc_items("yug_extrm", "rev")),
         # islamic extremism
          scM_fntcIslam.indv = compute_trait_score(.,
            get_fntc_items("islam_extrm", "pos"),
             get_fntc_items("islam_extrm", "rev")),
        # pan-cultural extremism
          scM_fntcPan.indv = compute_trait_score(.,
            get_fntc_items("pan_extrm", "pos"),
             get_fntc_items("pan_extrm", "rev")),
       
       # divine power
          scM_fntc_dp.indv = compute_trait_score(.,
            get_fntc_items("divine_power", "pos"),
             get_fntc_items("divine_power", "rev")),
       
       # proviolence
          scM_fntc_pv.indv = compute_trait_score(.,
            get_fntc_items("proviolence", "pos"),
             get_fntc_items("proviolence", "rev")),
       
       # vile world
          scM_fntc_vw.indv = compute_trait_score(.,
            get_fntc_items("vile_world", "pos"),
             get_fntc_items("vile_world", "rev")),
       
      #Failed State Perception
        scM_fsp.indv = compute_trait_score(.,
        paste0("fsp_", c(1, 2, 4, 5, 7, 8, 10, 11, "3b", "7c","9b", "11b")), 
        paste0("fsp_", c(3,6,8,9,"1b", "7b","10b"))
        )

  ) %>% 
  mutate(pID = paste0("p", 1:nrow(.)))%>% 
  
  #compute community[here, country] scale scores
  with_groups(country, 
    mutate,
    across(
      # Select all pty and mindset scaled scores  
      contains(c( "scP", "scM", "sc_swb")),
      # Compute mean by country
      ~mean(., na.rm = TRUE),
      # Create new name [scP_Hon.indv -> scP_Hon.comm]
      .names = "{str_remove(.col, '[.].*')}.comm"
    )
  )
#Mindset CNI-data [ips.Mindset items + sc_swb + sc_pty.indv + sc_pty.comm]
#Personality CNI-data [ips.Personality items + sc_swb + sc_pty.indv + sc_pty.comm]
```


```{r tbl-DescriptiveTable}
#| label: tbl-descriptive
#| tbl-cap: "Descriptive statistics by Country"

data1 %>% 
  group_by(country) %>% 
  summarize(mean_age = mean(age, na.rm=TRUE),
            percent.male = mean(gender == "male", na.rm=TRUE)*100,
            N = n()) %>% 
  arrange(desc(N)) %>% 
  kable(format = "latex", 
        col.names = c("Country", "Mean Age", "% Male", "n"), 
        booktabs = TRUE)
```

@tbl-descriptive indicates the sample details for all eight countries in this dataset.


# Analysis
## RQ1: Computing CNI

Using the approach by Weston et, al (2024), CNI is estimated using a random slope multilevel model (fixed intercepts; as the self and country responses have been ipsatized or standardized, the mean or the b0 will be zero) wherein the items are nested within persons. The ipsatization allows for the resulting slope estimates to be interpreted as correlation estimates.

Computing three types of CNI: - mindsetCNI: mindset variables - pty6CNI: six personality variables - pty7CNI: six personality variables + disintegration(paychopathology also considered as personality)

For study 1, six CNI models are computed:

:::{#note-CNI-models .callout-note title="CNI Models" icon=false}
1. Mindset CNI: consisting of all mindset items 
2. Isms CNI
3. Globe CNI: Original Globe items by House et al.
4. Fanaticism CNI
5. Personality 6 CNI: consisting of Big 6 items
6. Personality 7 CNI: Big 6 items + Disintegration items
:::

\*\*NOTE - write about ipsatization and controlling for overall mean when computing profile similarity analysis

To compute CNI's the data is processed in the following manner:
1.  Generate `z_ctry_responses`(Ipsatized/standardized within country responses)
2.  Generate `z_responses` (Ipsatized self rating responses; standardized within person)
3. To account for the normativity-desirability confound (NRC; Wood and Furr, 2016) we generate `Overall_M.responses` (Overall means of all items computed, uses Ipsatized self rating responses for all participants regardless of country). By adding this to the model we compute CNI estimates controlled for the overall mean profile that can confound the profile similarity between self-rating and country profiles. 

The data is retained in the long format. Each row consists of an item for each participant, country average response for each item and overall average for each item.

```{r funs.-model_CNI}
#FUNCTIONS for computing CNIs
 #Note: 1 here inidcates study 1

#item names for CNI type
get_item_names <- \(CNI_type, data) {
   
  domains <- switch(CNI_type,
    "Mindset" = c("Isms", "Fanaticism", "Social_Axioms", "Values", "Globe", "Failed_state_perception", "Values"),
    "pty6" = c("Personality6"),
    "pty7" = c("Personality6", "Personality7"),
    "Fanaticism" = c("Fanaticism"),
    "Isms" = c("Isms"),
    "Globe" = c("Globe"),
    stop("CNI type not found")
  )
  
  item_names <- data %>% 
    filter(domain %in% domains) %>% 
    pull(all_vars)
  
  if (length(item_names) == 0) {
    warning("No items found for the specified domains")
  }
  
  return(item_names)
}

#ipsatize/standardize scores
ipsatize <- \(x){
  value <- (x-mean(x, na.rm=T))/(sd(x, na.rm=T)) 
  return(value)
} 

#compute z_profiles for pID
compute_profiles <- \(var_names){
#compute mean country profiles
country_profiles <- data1 %>% 
  group_by(country) %>%
  summarise(
    across(all_of(var_names), ~mean(.x, na.rm = TRUE), .names = "avg_{.col}"),#variables for mindsetCNI
   n_p = n())%>% # number of participants) 
  ungroup() %>% 
  #retain participants who have responded to at least 30 items.- all the countries have n_p>30
  filter(n_p>=30) %>% 
   pivot_longer(
    cols = starts_with("avg_"),
    #item names stored in item
    names_to = "item",
    values_to = "ctry_response"
  ) %>% 
   mutate(item = str_remove(item, "avg_")) %>% 
ungroup()

self.ctry_profiles <-  data1 %>%
  select(all_of(var_names), pID, country) %>%
  pivot_longer(names_to = "item",
               values_to = "response",
               cols = all_of(var_names)) %>% 
  filter(!is.na(response)) %>%
  left_join(country_profiles, by = c("country", "item")) %>%
   filter(!is.na(ctry_response)) %>%
# ipsatize responses within profile 
  with_groups(pID, mutate, across(
    # mutate self-rating and mean country profiles for each pID at once
  contains("response"),
  # with the ipsatize function ,
  ipsatize,
  # create new name
.names = "z_{.col}")) 

overallM_profiles <- self.ctry_profiles %>% 
  select(item, z_response) %>%
  filter(!is.na(z_response)) %>%
  group_by(item) %>%
  summarise(overall.M = mean(z_response)) %>% 
  ungroup() 


return(lst(self.ctry_profiles, overallM_profiles)) #set_names() to the input object names

} 
```

```{r CNi-profiles}
#get all item names for CNI types
mindsetCNI_items <- get_item_names("Mindset", all_vars_d)
pty6CNI_items <- get_item_names("pty6", all_vars_d)
pty7CNI_items <- get_item_names("pty7", all_vars_d)
ismCNI_items <- get_item_names("Isms", all_vars_d)
fantcCNI_items <- get_item_names("Fanaticism", all_vars_d)
globeCNI_items <- get_item_names("Globe", all_vars_d)


#compute pofiles for each CNI type
mindsetCNI_profiles <- compute_profiles(mindsetCNI_items)
pty6CNI_profiles <- compute_profiles(pty6CNI_items)
pty7CNI_profiles <- compute_profiles(pty7CNI_items)
ismCNI_profiles <- compute_profiles(ismCNI_items)
fantcCNI_profiles <- compute_profiles(fantcCNI_items)
globeCNI_profiles <- compute_profiles(globeCNI_items)
globeCNI_profiles <- compute_profiles(globeCNI_items)
```

```{r DONT-RUN-fit-all-cni-mods, eval=FALSE, echo=TRUE}
#computing CNI
add_CNIformula <- \(data){
  lmer(z_response ~ z_ctry_response + overall.M + (-1 + z_ctry_response|country/pID), data = data)
  }

mindsetCNI_mod <- mindsetCNI_profiles$self.ctry_profiles %>% 
  full_join(mindsetCNI_profiles$overallM_profiles, by = "item") %>% add_CNIformula(.)
  
pty6CNI_mod <- pty6CNI_profiles$self.ctry_profiles %>% 
  full_join(pty6CNI_profiles$overallM_profiles, by = "item") %>% add_CNIformula(.)

pty7CNI_mod <- pty7CNI_profiles$self.ctry_profiles %>% 
  full_join(pty7CNI_profiles$overallM_profiles, by = "item") %>% add_CNIformula(.)

ismCNI_mod <- ismCNI_profiles$self.ctry_profiles %>% 
  full_join(ismCNI_profiles$overallM_profiles, by = "item") %>% add_CNIformula(.)

fantcCNI_mod <- fantcCNI_profiles$self.ctry_profiles %>% 
  full_join(fantcCNI_profiles$overallM_profiles, by = "item") %>% add_CNIformula(.)

globeCNI_mod <- globeCNI_profiles$self.ctry_profiles %>% 
  full_join(globeCNI_profiles$overallM_profiles, by = "item") %>% add_CNIformula(.)

```

```{r save-CNImods, echo = F, eval = F}
save(mindsetCNI_mod, pty6CNI_mod,pty7CNI_mod,
     ismCNI_mod, fantcCNI_mod, globeCNI_mod,
     file = here("objects/Study1/all_CNI.mods_study1.Rdata"))
```

```{r load-CNImods, echo = F}
load(here("objects/Study1/all_CNI.mods_study1.Rdata"))
```


### Model Complexity

The six CNI models vary in the number of items and domains of psychological measures.
1. The Parallel Analysis computed here, identify the optimum number of dimensions that the data for every CNI type can be reduced to. The optimum number of dimensions are retained based on the comparison of eigenvalues of the actual data and those of randomly generated data sets. Dimensions are retained when their eigenvalues exceed those of the random data, ensuring that only factors accounting for more variance than would be expected by chance are retained. 
2. Unrotated Principal Components that explain at least 50% of variance are identified.
These metrics provide quantitative measures of the underlying dimensionality and structure of each CNI.

```{r DONT-RUN-fun.-heterogeneity, message=FALSE, warning=FALSE, eval=F}
# Function to calculate heterogeneity
compute_heterogeneity <- function(data) {
  # Compute correlation matrix once - memory efficient
  cor_matrix <- cor(data, use = "pairwise.complete.obs")
  
  pca_rotation <- function(rotation) {
    # Perform PCA using correlation matrix
    pca <- principal(cor_matrix, nfactors = ncol(data), rotate = rotation, covar = FALSE)
    
    # Calculate cumulative variance explained
    cumulative_var <- cumsum(pca$values) / sum(pca$values)
    
    # Find number of factors needed to explain at least 50% variance
    heterogeneity <- which(cumulative_var >= 0.5)[1]
    
    return(heterogeneity)
  }
  
  # Perform parallel analysis using correlation matrix
  pa_result <- fa.parallel(cor_matrix, n.obs = nrow(data), fa = "fa", fm = "minres", show.legend = FALSE, plot = FALSE)
  
  tibble(
    n_items = ncol(data),
    pa = pa_result$nfact,
    pca_50 = pca_rotation("none")
  )
}

heterogeneity_stats <- map_dfr(
  list(
   Mindset = select(data1, 
               get_item_names("Mindset",
                              all_vars_d)),
  Globe = select(data1,
                get_item_names("Globe",
                              all_vars_d)),
   Isms = select(data1,
                get_item_names("Isms",
                              all_vars_d)),
   Fanaticism = select(data1,
                get_item_names("Fanaticism",
                              all_vars_d)),
   Personality6 = select(data1,
                get_item_names("pty6",
                              all_vars_d)),
   Personality7 = select(data1,
                get_item_names("pty7",
                              all_vars_d))
  
),
 compute_heterogeneity, .id = "cni_type"
)
```

```{r save-heterogeneity_stats, echo = F, eval = F}
save(heterogeneity_stats, 
     file = here("objects/Study1/heterogeneity_stats.Rdata"))
```

```{r load-heterogeneity_stats, echo = F}
load(here("objects/Study1/heterogeneity_stats.Rdata"))
```

```{r tbl-model-complexity, results='asis', message=F}
#| tbl-cap: "Model complexity"
#| label: tbl-model-complexity

heterogeneity_stats %>% 
  kable(booktabs = T, 
        escape = F,
        format = "latex",
        col.names = c("CNI type", "No. items", "Parallel analysis", "PCA")) %>% 
  kable_styling() %>% 
     group_rows("Mindset", 1, 4) %>%
     group_rows("Personality", 5, 6) %>% 
   add_footnote("Note: Personality6 = Big 6 items; Personality7 = Big 6 items + Disintegration.", notation = "none")
```

```{r plot-model-complexity, results='asis'}
#| fig-height: 6
#| fig-width: 10
#| out-width: "100%"
#| fig-cap-location: bottom
#| fig-cap: "Model Complexity Measures Across CNI Models"
#| label: fig-plot-model-complexity

heterogeneity_stats %>%
  pivot_longer(cols = c(pa, pca_50), names_to = "metric", values_to = "value") %>%
  mutate(x_label = paste0(cni_type, "\n(", n_items, " items)"),
         x_label = reorder(x_label, n_items)) %>% 
# Create the plot
ggplot(., aes(x = x_label, y = value, color = metric, group = metric)) +
  geom_line() +
  geom_point(size = 3) + 
  scale_color_manual(values = c("pa" = "#e78f8e", "pca_50" = "#93bfa6"),
                     labels = c("pa" = "Parallel Analysis", "pca_50" = "PCA 50%"),
                     name = "Metric") +
  labs(x = "CNI Type",
       y = "No. of Components") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        text = element_text(family="serif", size = 13))
```

An increase in CNI complexity is observed with an increase in the number of items (@fig-plot-model-complexity). 


### CNI plots

```{r fun.-plot_CNI}
#Functions
#model1_est = tidy(model1, conf.int = T)

#this function does not work with map for some reason, the color mapping does not work!! 
plot_CNI <- function(model_obj) {
  # Get the name of the object passed to the function
  obj_name <- deparse(substitute(model_obj))
  
  # Extract the title (everything before the underscore)
  title <- str_extract(obj_name, "^[^_]+")
  
  # Define color mapping
  color_map <- tibble(
    mod_name = c("mindsetCNI", "ismCNI", "globeCNI", "fantcCNI", "pty6CNI", "pty7CNI"),
    color = c("#1e81b0", "#70d6ff", "#a7bed3", "#a0c4ff", "#ff7477", "#ff70a6")
  )
  
  # Determine the color based on the title
  plot_color <- color_map %>% 
    filter(str_detect(mod_name, title)) %>% 
    pull(color)
  
  # Calculate slopes
  mod_slopes <- slopes(model_obj, variables = "z_ctry_response", by = "pID")
  
  coefficient_plot <- mod_slopes %>%
      ggplot(aes(x = reorder(pID, estimate), y = estimate)) +
      geom_segment(aes(xend = pID,
y = conf.low,yend = conf.high),
                   alpha = .08 , color = plot_color) +
      geom_point(size = .22, color = plot_color) +
      scale_x_discrete(breaks = NULL) +
      #coord_cartesian(ylim = c(-0.2, .92)) +
      labs(x = "Participant", y = "CNI coefficient", title = title) +
      theme_bw() +
    theme(text = element_text(family = "serif"))
  
   hist_plot <- mod_slopes %>%
    as.data.frame() %>%
    ggplot(aes(x = estimate)) +
    geom_histogram(binwidth = .03, color = "white", fill = plot_color) +
    labs(x = "CNI coefficient", y = "Frequency", title = title) +
    scale_x_continuous(limits = c(-0.3, 0.92))+
    theme_bw() +
    theme(text = element_text(family = "serif"))
  
  return(lst(mod_slopes, coefficient_plot,hist_plot ))
}
```

```{r  DONT-RUN-CNIplots, results = 'asis', eval = FALSE}
mindsetCNI_plot <- plot_CNI(mindsetCNI_mod) 
ismCNI_plot <- plot_CNI(ismCNI_mod) 
globeCNI_plot <- plot_CNI(globeCNI_mod)
fantcCNI_plot <- plot_CNI(fantcCNI_mod)
pty6CNI_plot <- plot_CNI(pty6CNI_mod)
pty7CNI_plot <- plot_CNI(pty7CNI_mod)
```

```{r save-CNImods_plots, echo = F, eval = F}
save(mindsetCNI_plot, ismCNI_plot, globeCNI_plot, fantcCNI_plot, pty6CNI_plot, pty7CNI_plot, 
     file = here("objects/Study1/all_CNImods_plots.Rdata"))
```

```{r load-CNImods_plots, echo = F}
load(here("objects/Study1/all_CNImods_plots.Rdata"))
```


```{r fun.-patch_CNIplots, echo = FALSE}
patch_CNIplots <- \(plot_list){
  
  p1 <- plot_list$coefficient_plot & 
  theme(plot.title = element_blank())
  
  p2 <- plot_list$hist_plot & 
  theme(plot.title = element_blank())
  
  combined_plot <- p1 + p2
  
  return(combined_plot)
}

# info for walk
cni_plot_details <- tibble(
  cni_type = c("mindset", "ism", "globe", "fantc", "pty6", "pty7"), 
caption = c("Mindset CNI", "Isms-Mindset CNI", "Globe-Mindset CNI",
     "Fanaticism-Mindset CNI", "Personality6 CNI", "Personality7 CNI")) %>% 
  mutate(cni_mod = paste0(cni_type, "CNI_plot"))
```

```{r echo = FALSE}
#| fig-height: 4
#| fig-width: 10
#| out-width: "100%"
#| cap-location: bottom
#| fig-cap: 
#|   !expr cni_plot_details %>%
#|     pull(caption)

#retain models that have mindset moderators
cni_plot_details %>%
  pwalk(function(cni_mod,  ...) { 
    cat("\n\n")
    print(patch_CNIplots(get(cni_mod))) 
    cat("\n\n")
  })
```

```{r range-CNI, eval=F, echo=F}

cni_plot_details %>% 
  pull(cni_mod) %>% 
  map_dfr(~{
    # Get the object from the global environment
    plot_obj <- get(.x, envir = .GlobalEnv)

    plot_obj$mod_slopes %>%
      tibble() %>% 
      summarize(
        low = min(estimate),
        high = max(estimate),
        range = high - low
      ) %>%
      mutate(model = .x)
  }) %>%
  # Reorder columns to have 'model' first and include the calculated range
  select(model, low, high, range) %>% 
  # Rename the models as requested
  mutate(model = case_when(
    model == "mindsetCNI_plot" ~ "Mindset CNI",
    model == "ismCNI_plot" ~ "Isms CNI",
    model == "globeCNI_plot" ~ "Globe CNI",
    model == "fantcCNI_plot" ~ "Fanaticism CNI",
    model == "pty6CNI_plot" ~ "Personality 6 CNI",
    model == "pty7CNI_plot" ~ "Personality 7 CNI",
    TRUE ~ model
  )) %>% 
  arrange(desc(range))
```


```{r DONT-RUN-create-tbl-cni-mods, echo = T, eval = F}
options(modelsummary_get = "easystats")
CNImods_table1 <- modelsummary(
  list("Mindset" = mindsetCNI_mod,
       "Ism" = ismCNI_mod,
       "Globe" = globeCNI_mod,
       "Fanaticism" = fantcCNI_mod,
       "Pty6" = pty6CNI_mod,
       "Pty7" = pty7CNI_mod), 
             estimate = "{estimate}{stars}",
             statistic = "[{conf.low}, {conf.high}]",
            # group = group + term ~ model, 
             coef_omit = "Intercept|^status",
             coef_rename = c(
              "z_ctry_response" = "CNI",
               "overall.M" = "Overall Mean Profile",
               "SD (z_ctry_response pIDcountry)" = "SD of CNI (across people)",
               "SD (z_ctry_response country)" = "SD of CNI (across country)",
               "SD (Observations)" = ""),
             gof_map = c("nobs"), 
             fmt = "%.2f",
             output = "kableExtra",
  escape = TRUE) %>% 
 # latex_options = "HOLD_position") %>% 
 # kable(format = "latex") %>% 
  add_header_above(c(" ", "Mindset" = 4, "Personality" = 2)) %>% 
  column_spec(6, extra_css = "position: relative;") %>%
  column_spec(7, extra_css = "position: relative;") 

```

```{r save-CNItable, echo = F, eval = F}
save(CNImods_table1,
     file = here("objects/Study1/CNImods_table1.Rdata"))
```

```{r load-CNItable, echo = F}
load(here("objects/Study1/CNImods_table1.Rdata"))
```


```{r tbl-cni-mods, results='asis', echo=F, eval=T}

#|tbl-cap: "Mindset and Personality Cultural Normativity Index (CNI) Models"

CNImods_table1
```

### CNI Country trends
Across countries the CNI types could potentially indicate varying trends. This was assessed by studying the country level CNI's (random slopes, "z_ctry_response"). 

```{r DONT-RUN-cni.ctry-trends, eval=F, echo=T}
#CNI country estimates from `slopes` (also can get CI's here) and `coef` (no CI's) are very close, both provide total effects (fixed+random)
#mindsetCNI_mod_ctry.slopes <- slopes(mindsetCNI_mod , variables = "z_ctry_response", by = "country")

all_mods_ctry.trends <- map_dfr(lst(
  mindsetCNI_mod, ismCNI_mod, globeCNI_mod,fantcCNI_mod,
  pty6CNI_mod, pty7CNI_mod), 
                 ~slopes(., variables = "z_ctry_response", by = "country"), .id = "model") 
```


```{r save-country-trends, echo = F, eval = F}
save(all_mods_ctry.trends,
     file = here("objects/Study1/CNI-ctry-trends1.Rdata"))
```

```{r load-country-trends, echo = F}
load(here("objects/Study1/CNI-ctry-trends1.Rdata"))
```


```{r tbl-ctry.trends-allCNImods, results='asis', echo=F, eval=T}
#|label: tbl-ctry.trends-allCNImods
#|tbl-cap: "Country estimates across CNI types"

all_mods_ctry.trends %>% 
  tibble() %>% 
  select(model, country, estimate, conf.low, conf.high, p.value) %>%
    mutate(
    p.value = map_chr(p.value, papaja::printp),
    across(where(is.numeric), ~ round(., 3)),
  ci = paste0("[", conf.low, ", ", conf.high,"]"),
    estimate = as.character(estimate) 
  ) %>% 
  select(country, estimate, ci, p.value) %>% 
   kable(booktabs = T, 
        escape = F,
        format = "latex",
        longtable = TRUE,
       # longtable = T,
        col.names = c("Country", "Estimate", "95\\% CI", "$\\textit{p}$")) %>% 
  kable_styling(latex_options = c("repeat_header", "longtable")) %>% 
  group_rows("Mindset CNI", 1, 8) %>% 
  group_rows("Isms-Mindset CNI", 8+1, 8*2) %>%  
  group_rows("Globe-Mindset CNI", 8*2+1, 8*3) %>% 
  group_rows("Fanaticism-Mindset CNI", 8*3+1, 8*4) %>%
  group_rows("Personality6 CNI", 8*4+1, 8*5) %>% 
  group_rows("Personality7", 8*5+1, 8*6) %>% 
  column_spec(1, width = "5cm")

```

```{r fun.-oneCoef-plot, echo = F, eval = F}
#One coefficient plot at a time!
plotCNI_ctry_trends <- \(slope_data){
  
  obj_name <- deparse(substitute(slope_data))
  title <- str_extract(obj_name, "^[^_]+")
  
  plot <- slope_data %>% 
  as_tibble() %>% 
  select(country, estimate, conf.low, conf.high) %>% 
   ggplot(aes(x = reorder(country,estimate), y = estimate)) +
   geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                color = "grey") +
   geom_point() + 
   scale_y_continuous(limits = c(0, 1)) +
   labs(x = NULL, 
        y = "CNI",
        title = paste0(title, " estimates across countries")) +
   coord_flip() +
   theme_bw() +
   theme(plot.title.position = "plot")
  
  return(plot)
}
#plotCNI_ctry_trends(mindsetCNI_mod_ctry.slopes)
```

```{r ctry-trends-3models-plot, echo=F, eval=T}
#| fig-height: 8
#| fig-width: 10
#| out-width: "100%"
#| fig-cap: "CNI estimates across countries: Three CNIs"
#| fig-cap-location: bottom

all_mods_ctry.trends %>% 
  mutate(model = str_extract(model, "^[^_]+")) %>% 
  filter(model %in% c("mindsetCNI", "pty6CNI", "pty7CNI")) %>% 
  mutate(model = case_when(
    model == "mindsetCNI" ~ "Mindset CNI",
    model == "pty6CNI" ~ "Personality 6 CNI",
    model == "pty7CNI" ~ "Personality 7 CNI",
    TRUE ~ model
  )) %>% 
  select(model, country, estimate, conf.low, conf.high) %>% 
  ggplot(aes(x = reorder(country, estimate), y = estimate, 
             color = model)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                position = position_dodge(width = 0.5), 
                width = 0.3) +
  geom_point(position = position_dodge(width = 0.5), 
             size = 1.7)+ 
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("Mindset CNI" = "#1e81b0", 
     "Personality 6 CNI" = "#ff7477", "Personality 7 CNI" = "#ff70a6")) + 
  labs(x = NULL, 
       y = "CNI",
       color = "Model") +
  coord_flip() +
  theme_bw() +
  theme(plot.title.position = "plot",
        legend.position = "bottom",
        text = element_text(family = "serif", size = 14.2))
```


```{r ctry-trends-6models-plot, echo=F, eval=T}
#| fig-height: 8
#| fig-width: 10
#| out-width: "100%"
#| fig-cap: "CNI estimates across countries: Six CNIs"
#| fig-cap-location: bottom

all_mods_ctry.trends %>% 
  as_tibble() %>% 
  mutate(model = str_extract(model, "^[^_]+")) %>% 
  mutate(model = case_when(
    model == "mindsetCNI" ~ "Mindset CNI",
    model == "pty6CNI" ~ "Personality 6 CNI",
    model == "pty7CNI" ~ "Personality 7 CNI",
    model == "ismCNI" ~ "Isms-Mindset CNI",
    model == "fantcCNI" ~ "Fanaticism-Mindset CNI",
    model == "globeCNI" ~ "Globe-Mindset CNI",
    TRUE ~ model
  )) %>% 
  select(model, country, estimate, conf.low, conf.high) %>% 
  ggplot(aes(x = reorder(country, estimate), y = estimate, color = model, linetype = model)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                position = position_dodge(width = 0.5), width = 0.4) +
  geom_point(position = position_dodge(width = 0.5), size = 1.7) + 
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(values = c("Mindset CNI" = "#1e81b0", "Isms-Mindset CNI"  = "#70d6ff", "Globe-Mindset CNI"  = "#a7bed3", "Fanaticism-Mindset CNI"  = "#a0c4ff", "Personality 6 CNI" = "#ff7477", "Personality 7 CNI" = "#ff70a6")) +
   scale_linetype_manual(values = c("Globe-Mindset CNI"  ="dashed", "Isms-Mindset CNI"  ="dashed", "Fanaticism-Mindset CNI"  ="dashed", "Mindset CNI" = "solid", "Personality 7 CNI" = "solid","Personality 6 CNI" = "solid")) +
  labs(x = NULL, y = "CNI", 
       color = "Model") +
  coord_flip() +
  theme_bw() +
  theme(plot.title.position = "plot",
        legend.position = "bottom",
        text = element_text(family = "serif", size = 14.2))+
  guides(linetype = "none")
```

# RQ 2: Associations between CNI and personality and mindset variables

CNI \~ Continuous moderators

```{r fun.-cni-mod-effects}
# Moderators here have to continuous, this won't work for categorical moderators
#Explanation for function below
      #[which CNI-type]:
  #cni_profiles_data <- mindsetCNI_profiles1$self.ctry_profiles 
      #[which moderator]:
  #modtr_pattern <- "^scP.*indv$" (scP = pty; scM = mindset)
      #[causal relationship]:
  #CNI <- Continuous moderator
cni.ContMod_effects <- \(cni_profiles_data, modtr_pattern){
  
#right data format
cni.modtr_data <- data1 %>% 
  #select moderator scales individual level (pID) scores 
  #---$select moderators$ - specify regex
  select(pID, matches(modtr_pattern)) %>% 
  #mean centering the moderator score cols
  #since this standardization is col-wise, running pty7 is not an issue
   mutate_if(is.numeric, 
             ~. - mean(., na.rm = T)) %>% 
  pivot_longer(-pID, 
                names_to = "modtr", #moderator name
                values_to = "modtr_score") %>% # moderator score
  full_join(cni_profiles_data, by = c("pID"), relationship = "many-to-many")

#CNI <- moderator
cni.modtr_models <- cni.modtr_data %>%
  tidyr::nest(data = -modtr) %>%
  mutate(
    #cni ~ mod
    mod.linear = map(data, ~lmer(z_response ~ z_ctry_response * modtr_score + (-1 + z_ctry_response | pID), data = .)),
    #cni ~ mod + mod^2
    mod.quadratic = map(data, ~lmer(z_response ~ z_ctry_response * modtr_score + z_ctry_response * I(modtr_score^2) + (-1 + z_ctry_response | pID), data = .)),
    
    #save results
    tidy_mod.linear = map(mod.linear, tidy, conf.int = T),
    tidy_mod.quadratic = map(mod.quadratic, tidy, conf.int = T)
  )

results_linear <- cni.modtr_models %>% 
  select(modtr, tidy_mod.linear) %>% 
  unnest(cols = c(tidy_mod.linear)) %>%
  filter(term == "z_ctry_response:modtr_score") %>% 
  select(modtr, term, estimate, conf.low, conf.high, p.value)

results_quadratic <- cni.modtr_models %>% 
  select(modtr, tidy_mod.quadratic) %>% 
  unnest(cols = c(tidy_mod.quadratic)) %>%
  filter(term == "z_ctry_response:I(modtr_score^2)") %>% 
  select(modtr, term, estimate, conf.low, conf.high, p.value)

return(lst(cni.modtr_models, results_linear, results_quadratic))

}

# cCNI.pty7_indv_try <- cni.ContMod_effects(
#   mindsetCNI_profiles$self.ctry_profiles, #cni profile
#   "^scP.*indv$") #moderators
```

```{r fun.-cni.ContMod_effects_tblData}
cni.ContMod_effects_tblData <- function(CNIprofile_data, variable_type) {
  if (variable_type == "personality") {
    var_pattern_indv <- "^scP.*indv$"
    var_pattern_comm <- "^scP.*comm$"
  } else if (variable_type == "mindset") {
    var_pattern_indv <- "^scM.*indv$"
    var_pattern_comm <- "^scM.*comm$"
  } else if (variable_type == "swb") {
    var_pattern_indv <- "^sc_swb.*indv$"
    var_pattern_comm <- "^sc_swb.*comm$"
  } else {
    stop("Invalid variable_type. Must be 'personality', 'mindset', or 'swb'.")
  }
  
  indv <- cni.ContMod_effects(
    CNIprofile_data$self.ctry_profiles, # cni profile
    var_pattern_indv # moderators
  )
  
  comm <- cni.ContMod_effects(
    CNIprofile_data$self.ctry_profiles, # cni profile
    var_pattern_comm # moderators
  )
  
  table <- bind_rows(
    Individual = indv$results_linear,
    Individual = indv$results_quadratic,
    Community = comm$results_linear,
    Community = comm$results_quadratic,
    .id = "level"
  )
  
  message(paste("Table ready for", deparse(substitute(CNIprofile_data)), "with variable type", variable_type))
  
  return(table)
}
```

```{r fun.-specify-var-names}
#function to specify the correct variable names for all moderators [Pty + Mindset + swb]
specify_var_names <- \(data){
  data %>% 
    mutate(
    modtr = case_when(
      
      #Personality
      str_detect(modtr, "Con") ~ "Conscientiousness",
      str_detect(modtr, "Hon") ~ "Honesty",
      str_detect(modtr, "Agr") ~ "Agreeableness",
      str_detect(modtr, "Res") ~ "Resilience",
      str_detect(modtr, "Ext") ~ "Extraversion",
      str_detect(modtr, "Vir") ~ "Originality/Virtuosity",
      str_detect(modtr, "Dis") ~ "Disintegration",
      
      #Mindset 
      str_detect(modtr, "ism_alpha") ~ "Alpha", 
      str_detect(modtr, "ism_beta") ~ "Beta",
      str_detect(modtr, "ism_gamma") ~ "Gamma",
      str_detect(modtr, "ism_delta") ~ "Delta",
      str_detect(modtr, "globe_tr") ~ "Traditional family structure",
      str_detect(modtr, "globe_un") ~ "Uncertainty avoidance",   
      str_detect(modtr, "globe_ac") ~ "Achievement orientation",
      str_detect(modtr, "globe_ag") ~ "Assertiveness", 
      str_detect(modtr, "globe_hu") ~ "Humane",
      str_detect(modtr, "globe_ma") ~ "Masculinity",
      str_detect(modtr, "globe_in") ~ "Ingroup Collectivism",
      str_detect(modtr, "globe_po") ~ "Power distance",
      str_detect(modtr, "globe_fu") ~ "Future orientation",
      str_detect(modtr, "fntc\\.") ~ "Fanaticism",
      str_detect(modtr, "fntcYug") ~ "Extremism - Yugoslavia",
      str_detect(modtr, "fntcIslam") ~ "Extremism - Islam",
      str_detect(modtr, "fntcPan") ~ "Extremism - pan-cultural",
      str_detect(modtr, "fntc_dp") ~ "Divine Power",
      str_detect(modtr, "fntc_pv") ~ "Proviolence",
      str_detect(modtr, "fntc_vw") ~ "Vile world",
      str_detect(modtr, "fsp") ~ "Failed state perception",
      
      #Subjective well-being 
      str_detect(modtr, "swb") ~ "Subjective Well-being",
      TRUE ~ modtr
    )
  ) 
}
```

```{r cni.ContMod_tblNames}
#generate inputs for cni.ContMod_effects_tblData
#ismCNI.mindset <- cni.ContMod_effects_tblData(ismCNI_profiles, "mindset")
#lot of models call for such measures!
cni.ContMod_tblNames <- tibble(table_name = c(
                       "mindsetCNI.pty7", "mindsetCNI.mindset" ,
                      "ismCNI.pty7", "ismCNI.mindset",
                       "globeCNI.pty7", "globeCNI.mindset",
                       "fantcCNI.pty7", "fantcCNI.mindset",
                       "pty6CNI.pty7", "pty6CNI.mindset",
                       "pty7CNI.pty7", "pty7CNI.mindset")
                      ) %>%
  mutate(
    cni_type = paste0(str_extract(table_name, "^[^.]+"), "_profiles"),
    
    variable_type = case_when(
      str_extract(table_name, "[^.]+$") == "pty7" ~ "personality",
      str_extract(table_name, "[^.]+$") == "mindset" ~ "mindset",
      TRUE ~ NA_character_
    )
  )
```

```{r DONT-RUN-cni.ContMod-effects, echo = F, eval = F}
#CNI <- continuous moderator
#takes forever! ~33mins
cni.ContMod_tables <- map2(
  .x = cni.ContMod_tblNames$cni_type,
  .y = cni.ContMod_tblNames$variable_type,
  .f = function(x, y) {
    # Use get() to retrieve the object by its name
    data <- get(x)
    
    # Call the function with the retrieved data and the variable type
    cni.ContMod_effects_tblData(data, y)
  }
) %>% 
  # Set names of the resulting list
  set_names(cni.ContMod_tblNames$table_name)

```

```{r save-cni.ContMod-effects, echo = F, eval = F}
save(cni.ContMod_tables,
     file = here("objects/Study1/cni.ContMod_tables1.Rdata"))

```

```{r load-cni.ContMod-effects-tbl, echo = F}
#takes a while to load
load(here("objects/Study1/cni.ContMod_tables1.Rdata"))
# [~33mins to load] 4:26pm start - end 4:58pm end
```

## Descriptives - Effect size estimates 

```{r overall-ContEst-trends, results='asis'}
#| tbl-cap: "Descriptive Statistics for Continuos Moderator Effect size Estimates"
library(e1071)

list_rbind(cni.ContMod_tables, names_to = "model") %>% 
    mutate(level = case_when(
      level == "Community" ~ "Country",
      TRUE ~ level
    ),
    term = case_when(
      term == "z_ctry_response:modtr_score" ~ "Linear",
      term == "z_ctry_response:I(modtr_score^2)" ~ "Quadratic",
      TRUE ~ term
    )) %>% 
  group_by(term, level) %>%
  summarise(
    min = min(estimate),
    max = max(estimate),
    range = max - min,
    kurtosis = e1071::kurtosis(estimate), 
    skew = e1071::skewness(estimate), 
    n = n(),
    mean = mean(estimate),
    sd = sd(estimate),
    .groups = "drop"
  ) %>%
  mutate(across(where(is.numeric), ~round(., 2))) %>% 
  select(-term) %>% 
  kable(booktabs = T, 
        escape = F,
        format = "latex",
        col.names = c(" ", "min", "max", "range", "kurtosis", "skew", "n", "mean", "sd")) %>%  
   group_rows("Linear effects", 1, 2) %>% 
  group_rows("Quadratic effects", 3, 4) 
    
```

```{r overall-ContEst-trends-plot, eval = T, echo = F, results='asis'}
#| fig-cap: "Distribution of Continuos Moderator Effect size Estimates"
#| fig-width: 8
#| fig-height: 4

plot_cont_effects <- function(plot_type) {
   base_data <- list_rbind(cni.ContMod_tables, names_to = "model") %>%
    mutate(level = case_when(
      level == "Community" ~ "Country",
      TRUE ~ level
    ))
  
  plot_data <- switch(plot_type,
    "overall" = base_data,
    "linear" = base_data %>% filter(term == "z_ctry_response:modtr_score"),
    "quadratic" = base_data %>% filter(term == "z_ctry_response:I(modtr_score^2)"),
    stop("Invalid plot type. Use 'overall', 'linear', or 'quadratic'.")
  )
  
  plot <- ggplot(plot_data, aes(x = estimate, y = ..density..)) +
    geom_density(color = "grey40", fill = "grey80", alpha = 0.5) +
    geom_density(aes(fill = level, color = level), alpha = 0.5) +
    scale_fill_manual(values = c("Individual" = "cornflowerblue", "Country" = "pink")) +
    scale_color_manual(values = c("Individual" = "cornflowerblue", "Country" = "pink")) +
    scale_x_continuous(limits = c(-0.55, 0.45)) +
    scale_y_continuous(limits = c(0, 280))+
    theme_bw() +
   labs(x = "Effect size Estimates", y = "Density", fill = "Level", color = "Level")
  
  return(plot)
}


plot_cont_effects("overall") + 
plot_cont_effects("linear") +
plot_cont_effects("quadratic") + 
  plot_layout(
    axis_titles = "collect",
    guides = "collect"
  )  +
  plot_annotation(
    tag_levels = list(c("Overall", "Linear", "Quadratic"))
  ) &
  theme(
    plot.tag.position = c("top"),
    text = element_text(family = "serif", size = 12),legend.position = "bottom")
```

## Tables

### Linear and Quadratic effects

```{r fun.-cni.ContMod_all.effects_table}
cni.ContMod_effects_table <- \(data, title){

df1 <- data %>% 
    specify_var_names()%>% 
    mutate(
    p.value = map_chr(p.value, papaja::printp),
    across(where(is.numeric), ~ round(., 3)),
  ci = paste0("[", conf.low, ", ", conf.high,"]"),
         term = ifelse(str_detect(term, "2"), "Quadratic", "Linear"),
    estimate = as.character(estimate) 
  ) %>% 
  select(level, modtr, term, estimate, ci, p.value) %>% 
  pivot_longer(cols = c(estimate, ci, p.value),  names_to = "stat", values_to = "stat_value") %>% 
  unite(term, term, stat) %>% 
  pivot_wider(names_from = term, values_from = stat_value) %>% 
  arrange(desc(level)) %>%
  select(-level) %>% 
  select(modtr, contains("Linear"), contains("Quadratic"))

 # Calculate the number of rows for each level
no.modtrs <- df1 %>% 
  distinct(modtr) %>% 
  nrow()

df1 %>% 
  kable(booktabs = T, 
        escape = F,
        format = "latex",
        col.names = c(" ", "Est", "95\\% CI", "$\\textit{p}$", "Est", "95\\% CI", "$\\textit{p}$"),
        caption = title) %>% 
  kable_styling() %>% 
  add_header_above(c(" ", "Linear (b)" = 3, "Quadratic (b^2)" = 3)) %>% 
     group_rows("Individual level", 1, no.modtrs) %>% 
  group_rows("Country level", no.modtrs+1, no.modtrs*2) 
 
}
```

```{r cni.ContMod_tbl_details}
cni.ContMod_tbl_details <-  cni.ContMod_tblNames %>% 
  mutate(caption_part = rep(pull(cni_plot_details, caption), each = 2),
         caption = paste0("Associations between ",caption_part, " and ", variable_type, " traits"),
         title = str_replace_all(table_name , "\\.", "~")) %>% 
  select(table_name, title, caption, variable_type)
```

```{r cni.ContMod-tbls, echo = F, results='asis'}
#retain models that have mindset moderators
cni.ContMod_tbl_details %>%
  pwalk(function(table_name, caption, ...) {
    cat("\n\n")
    print(
      pluck(cni.ContMod_tables, table_name) %>% 
        cni.ContMod_effects_table(., caption)
    )
    cat("\n\n")
  })
```

### Overall trends
To distinguish the most influential effects, three categories of tables are presented here:

1. Strongest moderators: Effects that significantly enhance or diminish the impact of cultural normativity.
2. Weakest moderators: Effects that, while statistically significant, have minimal influence on cultural normativity.
3. Non-significant effects: Factors that show no statistically significant moderation of cultural normativity.

This comprehensive approach allows us to identify key moderators, subtle influences, and factors that do not play a substantial role in modifying the effect of cultural normativity.

```{r fun.-overall-effects-table}
overall_table <- function(table_type, title) {
  table <- bind_rows(cni.ContMod_tables, .id = "model")
  
  if (table_type == "overall highest") {
    table <- table %>%
      filter(p.value < .05) %>%
      arrange(desc(abs(estimate)))
  } else if (table_type == "overall weakest") {
    table <- table %>%
      filter(p.value < .05) %>%
      arrange(abs(estimate))
  } else if (table_type == "overall n.s") {
    table <- table %>%
      filter(p.value >= .05) %>%
      arrange(abs(estimate))
  } else {
    stop("Invalid table_type. Choose 'overall highest', 'overall lowest', or 'overall n.s'")
  }

final_table <- table %>%
  head(20) %>%
  specify_var_names() %>% 
  separate(model, c("CNI_type", "Moderator_type"), sep = "\\.") %>%
  mutate(
    CNI_type = str_remove(CNI_type, "CNI"),
    CNI_type = str_to_sentence(CNI_type),
    CNI_type = str_replace_all(CNI_type, c( 
      "cni" = " CNI",
      "Ism" = "Isms",
      "Fantc" = "Fanaticism",
      "Globe" = "GLOBE", 
      "Pty6" = "Personality 6",
      "Pty7" = "Personality 7")),
    Moderator_type = if_else(Moderator_type == "pty7", "Personality", "Mindset"),
    p.value = map_chr(p.value, papaja::printp),
    across(where(is.numeric), ~ round(., 3)),
    ci = paste0("[", conf.low, ", ", conf.high,"]"),
    term = ifelse(str_detect(term, "2"), "(b\\textsuperscript{2})", "(b)"),
    estimate = as.character(estimate),
    modtr = paste0(modtr, " (", Moderator_type, ")"),
    modtr = ifelse(level == "Country", 
                   paste0(modtr, footnote_marker_symbol(1, "latex")),
                   paste0(modtr, footnote_marker_symbol(2, "latex"))
    ),
    CNI_type = str_replace(CNI_type, "CNI", "")
  ) %>% 
  select(CNI_type, modtr, term, estimate, ci, p.value)

final_table %>% 
  kable(booktabs = T, 
        escape = F,
        format = "latex",
        col.names = c("CNI type", "Moderator", "Term", "Est", "95\\% CI", "$\\textit{p}$"),
        caption = title) %>% 
  kable_styling() %>% 
  footnote(symbol = c("Country", "Individual"),
           symbol_title = "",
           general = "(b) = Linear model, (b\\textsuperscript{2}) = Quadratic",
           general_title = "Note:",
           title_format = "italic", 
           fixed_small_size = TRUE,
           footnote_as_chunk = FALSE,
           threeparttable = TRUE)
}

overall_table_details <- tibble(
  table_type = c("overall highest", "overall weakest", "overall n.s"))%>% 
  mutate(title = paste0("Variables with ", word(table_type , 2), " effect sizes with each CNI type"))
```

```{r overall-effects-table, echo = F, results='asis'}
overall_table_details %>%
  pwalk(function(table_type, title) {
    cat("\n\n")
    print(overall_table(table_type, title))
    cat("\n\n")
  })
```



## Plots 
### Variable view: Overall effects 
Given that there are `r (length(str_subset(names(data1), "\\.(indv|comm)$"))-1)*2` (individual level scale scores = `r (length(str_subset(names(data1), "\\.(indv)$")))-1`, country level scale scores = `r (length(str_subset(names(data1), "\\.(comm)$")))-1` and their linear and quadratic associations with CNI types) effect sizes to evaluate in total for each CNI type, it was necessary to identify a starting point. In order to assess the continuous moderator effects for each of the CNI types, the highest 15 and lowest 15 associations (across linear and quadratic) were considered. 

```{r fun.plot-high-low-effects}
plot_high.low_mindset_effects <- function(data) {

  base_data <- data %>%
    specify_var_names() %>%
    filter(round(p.value, 3) < 0.05) %>% #distinct(level) %>% 
    arrange(desc(abs(estimate))) %>%
    mutate(
      level = case_when(
    level == "Community" ~ "Country",
    TRUE ~ level  # This keeps other values unchanged
  ),
      color = case_when(
        modtr %in% c("Alpha", "Beta", "Gamma", "Delta") ~ "Isms",
        modtr %in% c("Traditional family structure", "Uncertainty avoidance", "Achievement orientation",
                     "Assertiveness", "Humane", "Masculinity", "Ingroup Collectivism", "Power distance", "Future orientation") ~ "Globe",
        modtr %in% c("Fanaticism", "Extremism - Yugoslavia", "Extremism - Islam", "Extremism - pan-cultural",
                     "Divine Power", "Proviolence", "Vile world") ~ "Fanaticism",
        modtr == "Failed state perception" ~ "Failed state"
      ),
      term_type = case_when(
  term == "z_ctry_response:modtr_score" ~ "Linear",
  term == "z_ctry_response:I(modtr_score^2)" ~ "Quadratic",
  TRUE ~ NA_character_, 
        .default = NA_character_)
    )
  
  # Select 15 highest and 15 lowest estimates and tag them as 'Highest' or 'Lowest'
  highest_15 <- base_data %>% head(15) %>% mutate(group = "Highest 15 Estimates")
  lowest_15 <- base_data %>% tail(15) %>% mutate(group = "Lowest 15 Estimates")
  
  # Combine the data
  all_data <- bind_rows(highest_15, lowest_15)

  # Define the overall range of estimates for consistent axis scaling
  estimate_range <- range(c(all_data$conf.high, all_data$conf.low))

  # Define the plot
  combined_plot <- ggplot(all_data, 
    aes(x = reorder(modtr, estimate), y = estimate, color = color, linetype = term_type, shape = level, group = interaction(modtr, term_type, level))) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0, alpha = 0.3, size = 3, position = position_dodge(width = 0.4), linetype = "solid") +
    
    geom_point(size = 2, position = position_dodge(width = 0.4)) +
    
    geom_linerange(aes(ymin = 0, ymax = estimate), position = position_dodge(width = 0.4)) +
    
    scale_shape_manual(values = c("Country" = 15, "Individual" = 17), drop = FALSE) +
    scale_color_manual(values = c("Isms" = "#ff6f91", "Globe" = "#377EB8", "Fanaticism" = "#008f7a", "Failed state" = "#646199"), drop = FALSE) +
    scale_linetype_manual(values = c("Linear" = "dotdash", "Quadratic" = "solid"), drop = FALSE) +
    scale_y_continuous(limits = estimate_range) +  
    coord_flip() +
    facet_wrap(~group, ncol = 1, scales = "free_y")+
    theme_minimal(base_family = "serif", base_size = 12) +
    labs(
      x = NULL,
      y = "Estimate",
      color = "Domain",
      shape = "Level",
      linetype = "Association") +
            theme_bw() +
    theme(text = element_text(family = "serif", size = 12), legend.position = "bottom")+

    guides(
  color = guide_legend(ncol = 2, title.position = "top"),  # 2 columns for Domain
  shape = guide_legend(ncol = 1, title.position = "top"),  # 1 column for Level
  linetype = guide_legend(ncol = 1, title.position = "top")  # 1 column for Association
)


  return(combined_plot)
}

plot_high.low_pty_effects <- function(data) {
  base_data <- data %>%
   # cni.ContMod_tables$ismCNI.pty %>% 
    specify_var_names() %>%
    filter(round(p.value, 3) < 0.05) %>%
    arrange(desc(abs(estimate))) %>%
    mutate(
      level = case_when(
        level == "Community" ~ "Country",
        TRUE ~ level),
      color = modtr,
      term_type = case_when(
        term == "z_ctry_response:modtr_score" ~ "Linear",
        term == "z_ctry_response:I(modtr_score^2)" ~ "Quadratic",
        TRUE ~ NA_character_, 
        .default = NA_character_)
    )
  
  # Select 10 highest and 10 lowest estimates and tag them as 'Highest' or 'Lowest'
  highest_10 <- base_data %>% head(10) %>% mutate(group = "Highest 10 Estimates")
  lowest_10 <- base_data %>% tail(10) %>% mutate(group = "Lowest 10 Estimates")
  
  # Combine the data
  all_data <- bind_rows(highest_10, lowest_10)
  # Define the overall range of estimates for consistent axis scaling
  estimate_range <- range(c(all_data$conf.low, all_data$conf.high))
  
  # Define the plot
  combined_plot <- ggplot(all_data, 
    aes(x = reorder(modtr, estimate), y = estimate, color = color, linetype = term_type, shape = level, group = interaction(modtr, term_type, level))) +
   geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0, alpha = 0.3, size = 3, position = position_dodge(width = 0.4), stat = "identity", linetype = "solid") +
    
    geom_point(aes(shape = level), size = 2, position = position_dodge(width = 0.4)) +
    
    geom_linerange(aes(ymin = 0, ymax = estimate, linetype = term_type), position = position_dodge(width = 0.4)) +
    
    scale_shape_manual(values = c("Country" = 15, "Individual" = 17), drop = FALSE) +
    scale_fill_manual(values = c(
      "Conscientiousness" = "#ff6f91",
      "Honesty" = "#377EB8",
      "Agreeableness" = "#008f7a",
      "Resilience" = "#e6d021",
      "Extraversion" = "#d7573b",
      "Originality/Virtuosity" = "#c67533",
      "Disintegration" = "#646199"
    )) +
    scale_color_manual(values = c(
      "Conscientiousness" = "#ff6f91",
      "Honesty" = "#377EB8",
      "Agreeableness" = "#008f7a",
      "Resilience" = "#e6d021",
      "Extraversion" = "#d7573b",
      "Originality/Virtuosity" = "#c67533",
      "Disintegration" = "#646199"
    )) +
    scale_linetype_manual(values = c("Linear" = "dotdash", "Quadratic" = "solid"), drop = FALSE) +
    scale_y_continuous(limits = estimate_range) +  # Ensure consistent y-axis limits
    coord_flip() +
    facet_wrap(~group, ncol = 1, scales = "free_y") +  # Facet the plot into Highest and Lowest
    theme_minimal(base_family = "serif", base_size = 12) +
    labs(
      x = NULL,
      y = "Estimate",
      color = "Domain",
      fill = "Domain",
      shape = "Level",
      linetype = "Association") +
    theme_bw() +
    theme(
      text = element_text(family = "serif", size = 12), legend.position = "bottom")  +

    guides(
      color = guide_legend(ncol = 2, title.position = "top"),  # 2 columns for Domain
      fill = guide_legend(ncol = 2, title.position = "top"),  # 2 columns for Domain (for the ribbon)
      shape = guide_legend(ncol = 1, title.position = "top"),  # 1 column for Level
      linetype = guide_legend(ncol = 1, title.position = "top")  # 1 column for Association
    )
  
  return(combined_plot)
}
```

```{r echo=F}
#| fig-height: 10
#| fig-width: 7
#| out-width: "100%"
#| fig-cap-location: bottom
#| fig-cap: 
#|   !expr cni.ContMod_tbl_details %>%
#|   filter(variable_type == "mindset") %>% 
#|   mutate(caption = str_extract(caption, "Associations.*")) %>% 
#|     pull(caption)

cni.ContMod_tbl_details %>%
  filter(variable_type == "mindset") %>%
  pull(table_name) %>%
  walk(~ {
    cat("\n\n")
    # Extract the table and generate the plot
    table_data <- pluck(cni.ContMod_tables, .x )
    plot <- 
      plot_high.low_mindset_effects(table_data)

    print(plot)
    cat("\n\n")
  })
```

```{r echo=F}
#| fig-height: 10
#| fig-width: 7
#| out-width: "100%"
#| fig-cap-location: bottom
#| fig-cap: 
#|   !expr cni.ContMod_tbl_details %>%
#|   filter(variable_type == "personality") %>% 
#|   mutate(caption = str_extract(caption, "Associations.*")) %>% 
#|     pull(caption)

cni.ContMod_tbl_details %>%
  filter(variable_type == "personality") %>%
  pull(table_name) %>%
  walk(~ {
    cat("\n\n")
    # Extract the table and generate the plot
    table_data <- pluck(cni.ContMod_tables, .x )
    plot <- 
      plot_high.low_pty_effects(table_data)
    
    # Print the plot
    print(plot)
    cat("\n\n")
  })
```

### CNI view: Linear and Quadratic effects
These plots allow to visualize the causal effects of mindset and personality variables across CNI types. Linear and quadratic relations are plotted separately, while not setting the Estimate axis to same values across all plots. A more variable focused view can be seen in the previous section wherein the focus is mainly on the largest and smallest effects. This is a CNI focused view that allows for comprehending the behavior of variable estimates within every CNI type. 

```{r fun.-plot-cni.ContMod}
#"Moderating effects on CNI: Individual vs Country"
cni.pty_effects_plot <- function(data, association_type) {
  
  if (association_type == "linear") {
    data_ass.type <- data %>% #cni.ContMod_tables$globeCNI.pty7
      #linear effects
      filter(term == "z_ctry_response:modtr_score")
  } else if (association_type == "quadratic") {
    data_ass.type <- data %>% 
      #quadratic effects
      filter(term == "z_ctry_response:I(modtr_score^2)")
  } else {
    stop("Invalid association type. Choose 'linear' or 'quadratic'")
  }
   
    data_ass.type %>%  
    specify_var_names() %>% 
    with_groups(modtr, ~ mutate(.x, avg_abs_estimate = mean(abs(estimate)))) %>% 
    mutate(
      modtr = fct_reorder(modtr, avg_abs_estimate, .desc = FALSE),
      sig = case_when(
        p.value < .05 & estimate > 0 ~ "Pos",
        p.value < .05 & estimate < 0 ~ "Neg",
        TRUE ~ "NOT"),
      level = case_when(
        level == "Community" ~ "Country",
        TRUE ~ level
      ),
      asterisk = ifelse(p.value < 0.05, "*", ""),
      asterisk_position = ifelse(estimate > 0, conf.high, conf.low)
    ) %>%
    ggplot(aes(x = modtr, y = estimate, fill = modtr, alpha = level)) +
    geom_col(position = position_dodge(width = 0.8)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                  position = position_dodge(width = 0.8),
                  width = 0.25) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    # Add asterisks for significant results
    geom_text(aes(label = asterisk, 
                  y = asterisk_position,
                  vjust = 1.37),
              position = position_dodge(width = 0.8),
   show.legend  = FALSE,
              size = 5) +
    scale_fill_manual(values = c(
      "Conscientiousness" = "#ff6f91",
      "Honesty" = "#377EB8",
      "Agreeableness" = "#008f7a",
      "Resilience" = "#e6d021",
      "Extraversion" = "#d7573b",
      "Originality/Virtuosity" = "#c67533",
      "Disintegration" = "#646199"
    )) +
    scale_alpha_manual(values = c("Individual" = 1, "Country" = 0.4)) +
    labs(x = "Moderator", y = "Estimate",
         fill = "Trait", alpha = "Level") +
    theme_bw() +
    theme(legend.position = "bottom", 
          text = element_text(family = "serif", size = 12)) +
    coord_flip() +
    guides(fill = "none")  
}

cni.mindset_effects_plot <- function(data, association_type) {
  
  if (association_type == "linear") {
    data_ass.type <- data %>% 
      #linear effects
      filter(term == "z_ctry_response:modtr_score")
  } else if (association_type == "quadratic") {
    data_ass.type <- data %>% 
      #quadratic effects
      filter(term == "z_ctry_response:I(modtr_score^2)")
  } else {
    stop("Invalid association type. Choose 'linear' or 'quadratic'")
  }
  
  data_ass.type %>%
    specify_var_names() %>%
    with_groups(modtr, ~ mutate(.x, avg_abs_estimate = mean(abs(estimate)))) %>% 
    mutate(
      modtr = fct_reorder(modtr, avg_abs_estimate, .desc = FALSE),
      color = case_when(
        modtr == "Alpha" ~ "Isms",
        modtr == "Beta" ~ "Isms",
        modtr == "Gamma" ~ "Isms",
        modtr == "Delta" ~ "Isms",
        modtr == "Traditional family structure" ~ "Globe",
        modtr == "Uncertainty avoidance" ~ "Globe",
        modtr == "Achievement orientation" ~ "Globe",
        modtr == "Assertiveness" ~ "Globe",
        modtr == "Humane" ~ "Globe", 
        modtr == "Masculinity" ~ "Globe",
        modtr == "Ingroup Collectivism" ~ "Globe",
        modtr == "Power distance" ~ "Globe",
        modtr == "Future orientation" ~ "Globe",
        modtr == "Fanaticism" ~ "Fanaticism",
        modtr == "Extremism - Yugoslavia" ~ "Fanaticism",
        modtr == "Extremism - Islam"  ~ "Fanaticism",
        modtr == "Extremism - pan-cultural" ~ "Fanaticism",
        modtr == "Divine Power" ~ "Fanaticism",
        modtr == "Proviolence" ~ "Fanaticism",
        modtr == "Vile world" ~ "Fanaticism",
        modtr == "Failed state perception" ~ "Failed state"),
      sig = case_when(
        p.value < .05 & estimate > 0 ~ "Pos",
        p.value < .05 & estimate < 0 ~ "Neg",
        TRUE ~ "NOT"),
      level = case_when(
        level == "Community" ~ "Country",
        TRUE ~ level
      ),
      asterisk = ifelse(p.value < 0.05, "*", ""),
      asterisk_position = ifelse(estimate > 0, conf.high, conf.low)
    ) %>%
    ggplot(aes(x = modtr, y = estimate, fill = color, alpha = level)) +
    geom_col(position = position_dodge(width = 0.8)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                  position = position_dodge(width = 0.8),
                  width = 0.25) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    # Add asterisks for significant results
    geom_text(aes(label = asterisk, 
                  y = asterisk_position,
                  vjust = 1.37),
              position = position_dodge(width = 0.8), size = 5,
          show.legend = FALSE) +
    scale_fill_manual(values = c(
      "Isms" = "#ff6f91",
      "Globe" = "#377EB8",
      "Fanaticism" = "#008f7a",
      "Failed state" = "#646199"),
      guide = guide_legend(
        position = "bottom",
        ncol = 2,
        direction = "vertical")) +
    scale_alpha_manual(values = c("Individual" = 1, "Country" = 0.4),
      guide = guide_legend(
        position = "bottom",
        ncol = 1,
        direction = "vertical")) +
    labs(x = "Moderator", y = "Estimate",
         fill = "Trait", alpha = "Level") +
    theme_bw() +
    theme(legend.position = "bottom",
          text = element_text(family = "serif", size = 12)) +
    coord_flip()
}

cni.ContMod_plot_details <- cni.ContMod_tbl_details %>% 
    # Duplicate each row
    slice(rep(1:n(), each = 2)) %>%
    # Add association_type column
    mutate(association_type = rep(c("linear", "quadratic"), n() / 2)) %>%
    # Modify caption based on association_type
    mutate(caption = case_when(
     association_type == "linear" ~ paste0("Linear ", sub("Associations", "associations", caption)),
      association_type == "quadratic" ~ paste0("Quadratic ", sub("Associations", "associations", caption))
    ))
```

```{r echo = F}
#| fig-height: 12
#| fig-width: 10
#| out-width: "100%"
#| fig-cap-location: bottom
#| fig-cap: 
#|   !expr cni.ContMod_plot_details %>%
#|   filter(variable_type == "mindset") %>% 
#|     pull(caption)

cni.ContMod_plot_details %>%
  filter(variable_type == "mindset") %>% 
  select(table_name, association_type, caption) %>% 
  pwalk(function(table_name,association_type, caption) {
    cat("\n\n")
    print(
      pluck(cni.ContMod_tables, table_name) %>% 
        cni.mindset_effects_plot(association_type)
    )
    cat("\n\n")
  })
```

```{r echo=F}
#| fig-height: 12
#| fig-width: 10
#| out-width: "100%"
#| fig-cap-location: bottom
#| fig-cap: 
#|   !expr cni.ContMod_plot_details %>%
#|   filter(variable_type == "personality") %>% 
#|     pull(caption)

cni.ContMod_plot_details %>%
  filter(variable_type == "personality") %>% 
  select(table_name, association_type, caption) %>% 
  pwalk(function(table_name,association_type, caption) {
    cat("\n\n")
    print(
      pluck(cni.ContMod_tables, table_name) %>% 
        cni.pty_effects_plot(association_type)
    )
    cat("\n\n")
  })
```



```{r save-plots-personalityMods, echo=F, eval=F}
# Save plots so that they can be added to word.

# Mindset Moderators

library(ggplot2)
library(purrr)
library(here)
library(fs)

# Define the dimensions for your plots
plot_width <- 6.7 # in inches
plot_height <- 4.4  # in inches

# Specify the directory where you want to save the plots
save_dir <- here("scripts", "Study1_plots", "personality_mods")

# Create the directory if it doesn't exist
dir_create(save_dir)

# Modify your existing code to save each plot
cni.ContMod_tbl_details %>% 
  filter(variable_type == "personality") %>% 
  pull(table_name) %>% 
  walk(\(table_name) {
    # Generate the plot
    plot <- pluck(cni.ContMod_tables, table_name) %>% 
      cni.pty_effects_plot()
    
    # Create a filename for the plot
    plot_name <- paste0("plot_", table_name)
    filename <- here("scripts", "Study1_plots","personality_mods", paste0(plot_name, ".png"))
    
    # Save the plot
    ggsave(filename, plot, width = plot_width, height = plot_height)
    
    # Optionally, you can still print the plot to the console
    print(plot)
    
    cat("\nSaved plot to", filename, "\n\n")
  })
```

```{r save-plots-mindsetMods, echo=F, eval=F}
# Save plots so that they can be added to word.

# Mindset Moderators

library(ggplot2)
library(purrr)
library(here)
library(fs)

# Define the dimensions for your plots
plot_width <- 6.7 # in inches
plot_height <- 8.4  # in inches

# Specify the directory where you want to save the plots
save_dir <- here("scripts", "Study1_plots", "mindset_mods")

# Create the directory if it doesn't exist
dir_create(save_dir)

# Modify your existing code to save each plot
cni.ContMod_tbl_details %>% 
  filter(variable_type == "mindset") %>% 
  pull(table_name) %>% 
  walk(\(table_name) {
    # Generate the plot
    plot <- pluck(cni.ContMod_tables, table_name) %>% 
      cni.mindset_effects_plot()
    
    # Create a filename for the plot
    plot_name <- paste0("plot_", table_name)
    filename <- here("scripts", "Study1_plots", "mindset_mods",paste0(plot_name, ".png"))
    
    # Save the plot
    ggsave(filename, plot, width = plot_width, height = plot_height)
    
    # Optionally, you can still print the plot to the console
    print(plot)
    
    cat("\nSaved plot to", filename, "\n\n")
  })
```

### Variable specific plots
#### Agreeableness
#### Assertiveness
#### Ingroup collectivism 
#### Resilience

# RQ3.1: CNI~well-being

```{r DONT-RUN-swb-effects, echo = T, eval = F}
cni.swbMod_tblNames <- tibble(table_name = c("mindsetCNI.swb", "ismCNI.swb", "globeCNI.swb", "fantcCNI.swb", "pty6CNI.swb", "pty7CNI.swb")) %>%
  mutate(
    cni_type = paste0(str_extract(table_name, "^[^.]+"), "_profiles"),
    variable_type =  str_extract(table_name, "[^.]+$")
    )

cni.swbMod_tables <- map2(
  .x = cni.swbMod_tblNames$cni_type,
  .y = cni.swbMod_tblNames$variable_type,
  .f = function(x, y) {
    # Use get() to retrieve the object by its name
    data <- get(x)
    
    # Call the function with the retrieved data and the variable type
    cni.ContMod_effects_tblData(data, y)
  }
) %>% 
  # Set names of the resulting list
  set_names(cni.swbMod_tblNames$table_name)
```

```{r save-cni.swb-effects, echo = F, eval = F}
save(cni.swbMod_tables,
 file = here("objects/Study1/cni.swbMod_tables.Rdata"))
```

```{r load-cni.swbMod-effects, echo = F}
#takes a while to load
load(here("objects/Study1/cni.swbMod_tables.Rdata"))
```

```{r table-cni.swb_effects}
cni.swbMod_tables %>%
  imap(~mutate(.x, cni_type = .y, .before = level)) %>%
  list_rbind() %>% 
  arrange(desc(level)) %>% 
  specify_var_names()%>% 
    mutate(
    p.value = map_chr(p.value, papaja::printp),
    across(where(is.numeric), ~ round(., 3)),
  ci = paste0("[", conf.low, ", ", conf.high,"]"),
         term = ifelse(str_detect(term, "2"), "Quadratic", "Linear "),
    estimate = as.character(estimate) ) %>% 
  select(level, cni_type, modtr, term, estimate, ci, p.value) %>% 
  pivot_longer(cols = c(estimate, ci, p.value), names_to = "stat", values_to = "stat_value") %>% 
  unite(term, term, stat) %>% 
  pivot_wider(names_from = term, values_from = stat_value) %>% 
  select(-modtr, -level) %>% 
    kable(booktabs = T, 
        escape = F,
        format = "latex",
        col.names = c(" ", "Est", "95\\% CI", "$\\textit{p}$", "Est", "95\\% CI", "$\\textit{p}$"),
        caption = "Association between CNI and Subjective well-being") %>% 
  kable_styling() %>% 
  add_header_above(c(" ", "Linear (b)" = 3, "Quadratic (b^2)" = 3)) %>% 
     group_rows("Individual level", 1, 6) %>%
     group_rows("Country level", 7, 12) 
```

```{r fun.-plot-cni.swb_effects, echo=F}
cni.swb_effects_plot <- \(data){

data %>% 
#only linear effects
  filter(term == "z_ctry_response:modtr_score") %>%
   specify_var_names() %>%
   with_groups(modtr, ~ mutate(.x, avg_abs_estimate = mean(abs(estimate)))) %>% 
   mutate(
         modtr = fct_reorder(modtr, avg_abs_estimate, .desc = FALSE),
     color = case_when(
     cni_type == "mindsetCNI" ~ "Mindset CNI",
     cni_type == "ismCNI" ~ "Isms-Mindset CNI",
     cni_type == "globeCNI" ~ "Globe-Mindset CNI",
     cni_type == "fantcCNI" ~ "Fanaticism-Mindset CNI",
     cni_type == "pty6CNI" ~ "Personality 6 CNI",
     cni_type == "pty7CNI" ~ "Personality 7 CNI"),
     sig = case_when(
       p.value < .05 & estimate > 0 ~ "Pos",
       p.value < .05 & estimate < 0 ~ "Neg",
       TRUE ~ "NOT")) %>%
  ggplot(aes(x = color, y = estimate, fill = color, alpha = level)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), position = position_dodge(width = 0.8),
 width = 0.25) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
scale_fill_manual(values = c(
 "Fanaticism-Mindset CNI" = "#a0c4ff",
 "Mindset CNI" = "#1e81b0",
 "Isms-Mindset CNI" = "#70d6ff",
 "Globe-Mindset CNI" = "#1E90FF",
 "Fanaticism-Mindset CNI" ="#4B9CD3",
 "Personality 6 CNI" = "#ff7477",
 "Personality 7 CNI" = "#ff70a6"
)) +
  scale_alpha_manual(values = c("Individual" = 1, "Community" = 0.4)) +
  labs(x = "CNI type",
       fill = "CNI type", alpha = "Level") +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.title.x = element_blank(), 
        title = element_blank(),
        text = element_text(family = "serif", size = 12)) +
  coord_flip()+
  guides(fill = "none")
}
```

```{r plot-cni.swb_effects, echo=F}
#| label: fig-plot-cni.swb_effects
#| fig-height: 6
#| fig-width: 10
#| out-width: "100%"
#| fig-cap: "CNI predicted by Subjective Well-being"
 cni.swbMod_tables %>% 
  #add the tbl_name (model name) = cni_type as a col 
  imap(~mutate(.x, cni_type = .y, .before = level)) %>%
  list_rbind() %>% 
  arrange(desc(level)) %>% 
  mutate(cni_type = str_remove(cni_type, "\\..*$"), .before = level) %>%
 cni.swb_effects_plot(.)
```

@fig-plot-cni.swb_effects indicates that SWB is a stronger predictor of Personality CNI than Mindset-CNI. 

# RQ3.2: Well-being ~ CNI
The relative importance of different CNIs can be evaluated by their predictive power for well-being outcomes. A key research question is to what degree CNIs serve as predictors of various subjective well-being (SWB) measures.
In order to use SWB as an outcome variable we need to establish the measurement invariance of the life satisfaction scale used in the study. This will allow to make appropriate attributions about the causal relationships wherein the observed differences are due to true variation in the constructs rather than measurement artifacts.

## Measurement Invariance Analysis - SWB

```{r MeasurementInvariance-processing}
swb_MI.data <- data1 %>% 
  #swb items have been rescaled to a range of 1 to 5
  dplyr::select(starts_with("swb"), country)

swbModel = '
f1 =~ swb1 + swb2 + swb3 + swb4 + swb5
'
#-----Configural invariance-----#
swbModel.config <- measEq.syntax(
  configural.model = swbModel, 
  data = swb_MI.data, 
  group = "country") # column name of group variable

# fit the new model synatx to the data, 
fit.config <- cfa(as.character(swbModel.config), 
                  data = swb_MI.data, 
                  group = "country")

summary_config <- summary(fit.config, fit.measures = T)


#-----Metric invariance-----#
swbModel.metric <- measEq.syntax(
  configural.model = swbModel, 
  data = swb_MI.data, 
  group = "country",
  group.equal = c("loadings")) # column name of group variable


fit.metric <- cfa(as.character(swbModel.metric), 
                  data = swb_MI.data, 
                  group = "country")

summary_metric <- summary(fit.metric, fit.measures = T)

#-----Scalar invariance-----#
swbModel.scalar <- measEq.syntax(
  configural.model = swbModel, 
  data = swb_MI.data, 
  group = "country",
  group.equal = c("loadings", "intercepts")) # column name of group variable

fit.scalar <- cfa(as.character(swbModel.scalar), 
                  data = swb_MI.data, 
                  group = "country")

summary_scalar <- summary(fit.scalar, fit.measures = T)

#-----Strict invariance-----#
swbModel.strict <- measEq.syntax(
  configural.model = swbModel, 
  data = swb_MI.data, 
  group = "country",
  group.equal = c("loadings", "intercepts", "residuals")) # column name of group variable

fit.strict <- cfa(as.character(swbModel.strict), 
                  data = swb_MI.data, 
                  group = "country")


summary_strict <- summary(fit.strict, fit.measures = T)


#-----all fit stats-----#
fit_tbl <-  \(summary){
fit_stats <- c("chisq", "pvalue", "df",  "rmsea",  "rmsea.ci.lower", "rmsea.ci.upper", "srmr", "tli", "cfi")

get_all_fits <- \(summary, stat){
 fit_index <- summary$fit %>% 
   pluck(stat)
 formatted_index <- format(round(fit_index, 2), nsmall = 2)
    return(as.numeric(formatted_index))
}

df <- map2_df(.x = list(summary), .y = fit_stats, ~{
  tibble(fit_stats = .y, values = get_all_fits(.x, .y))
})

# Transform the data
 df <- df %>% 
    pivot_wider(names_from = "fit_stats", values_from = values) %>% 
    mutate(
      chisq = ifelse(pvalue < 0.05, glue("{chisq}**({df})"), glue("{chisq} ({df})")),
      RMSEA = glue("{rmsea} ({rmsea.ci.lower}, {rmsea.ci.upper})")
    ) %>% 
  dplyr::select(-pvalue, -df, -rmsea, - rmsea.ci.upper, -rmsea.ci.lower) %>% 
  rename("SRMR" = srmr,
         "TLI" = "tli",
         "CFI" = "cfi") %>% 
  dplyr::select(chisq, RMSEA, everything())

return(df)

}

# convert any input into a character string
convert_to_char <- \(...) {
  expr <- enquos(...)
  char_vector <- map_chr(expr, quo_name)
  return(char_vector)
}

#compute all the fit indices
MI_table <- map_df(list(summary_config, summary_metric, summary_scalar, summary_strict), .f = fit_tbl) %>% 
 #add invariance type col
  mutate(invariance_type = convert_to_char(Configural, Metric, Scalar, Strict),  .before = chisq) %>% 
 #add delta cols
 mutate(
    temp_RMSEA = as.numeric(str_extract(RMSEA, "\\d+\\.\\d+")),
    delta_CFI = c(NA, -diff(CFI)),
    delta_RMSEA = c(NA, diff(temp_RMSEA)),
    delta_SRMR = c(NA, diff(SRMR))
  ) %>%
  select(-temp_RMSEA)  

```

```{r MeasurementInvariance_Table}
#| label: tbl-MeasureMentInvariance
#| tbl-cap: "Measurement Invariance metrics for Subjective Well-being"

options(knitr.kable.NA = '')

MI_table %>% 
  kable(format = "latex", 
        booktabs = TRUE, 
        escape = FALSE, 
        col.names = c("Invariance type", "Chi square",
                      colnames(MI_table)[3:6], 
                      "Δ CFI", "Δ RMSEA", "Δ SRMR")) %>%
  kable_styling(latex_options = c("hold_position"))
```

Measurement invariance was assessed (@tbl-MeasureMentInvariance) for testing cross-cultural comparability of the 5-item Life Satisfaction scale measuring subjective well-being, across eight nations in Study 1. A series of increasingly constrained multi-group confirmatory factor analysis models were employed to evaluate configural, metric, scalar, and strict invariance.

- The `configural invariance` model, which tests for similarity in factor structure (pattern of zero and non-zero loadings) across groups showed acceptable fit (CFI = 0.94, TLI = 0.89, RMSEA = 0.13 \[90% CI: 0.11, 0.14\], SRMR = 0.04). While the CFI indicates acceptable fit (close to cutoff of ≥ 0.95), the TLI (based on typical cutoff for good fit: ≥ 0.95) and RMSEA (baed on typical cutoffs: < 0.05 for good fit, < 0.08 for reasonable fit) suggest some misfit.

- The `metric invariance` model, which constrains factor loadings to be equal across groups, demonstrated a slight decrease in fit (CFI = 0.92, TLI = 0.91, RMSEA = 0.12 \[90% CI: 0.11, 0.13\], SRMR = 0.0753). The change in CFI (ΔCFI = 0.02, exceeds the recommended threshold of ≤ 0.01, but within the more lenient threshold of ≤ 0.02) and RMSEA (ΔRMSEA = -0.0100, within acceptable limits of  ≤ 0.015), indicating partial support for metric invariance. 

- The `scalar invariance` model, which additionally constrains item intercepts to be equal across groups, showed a substantial decrease in fit (CFI = 0.78, TLI = 0.82, RMSEA = 0.17 \[90% CI: 0.16, 0.18\], SRMR = 0.13). The changes in fit indices (ΔCFI = 0.14, ΔRMSEA = 0.05, ΔSRMR = 0.05) far exceeded recommended thresholds, indicating that scalar invariance does not hold.

- The strict invariance model, which also constrains residual variances to be equal across groups, exhibited a further decline in fit (CFI = 0.54, TLI = 0.72, RMSEA = 0.21 \[90% CI: 0.2, 0.21\], SRMR = 0.16), indicating that strict invariance is not tenable. 

In summary, the SWB scale demonstrates partial support for configural and metric invariance across the eight nations, and there is evidence of non-invariance at scalar, and strict levels. These results suggest that while the basic structure of the scale could be similar across cultures, there may be differences in the strength of item-factor relationships, item intercepts, and item residuals across nations. Given the established complexity of SWB across cultures, we suggest that the readers approach the use of this construct with caution. 

## To what extent can CNI predict Subjective well-being?

To assess the degree to which CNI affects mental health outcomes, both linear and curvilinear relationships are examined to elucidate the overall association as well as the relationship across specific levels of each variable.

```{r swb.cni-lmer, eval=TRUE}
compute_swb.cni_mods_lmer <- \(cni_mod){
  data <- coef(cni_mod)$pID %>%
  as.data.frame() %>%
  mutate(pID = rownames(.)) %>%
  select(-`(Intercept)`) %>% 
  separate(pID, into = c("pID", "country")) %>% 
  rename(CNI = z_ctry_response) %>% 
  full_join(data1)
  
  linear.indv <- lmer(sc_swb.indv ~ CNI + (1 | country), data = data)
  
  linear.comm <- lmer(sc_swb.comm ~ CNI + (1 | country), data = data)
  
  quadratic.indv <- lmer(sc_swb.indv ~ CNI + I(CNI^2) + (1 | country), data = data)
  
   quadratic.comm <- lmer(sc_swb.comm ~ CNI + I(CNI^2) + (1 | country), data = data)
  
  return(lst(linear.indv,linear.comm,
             quadratic.indv, quadratic.comm))
   
}

all_swb.cni_mods <- map(
  lst(mindsetCNI_mod, ismCNI_mod, globeCNI_mod,fantcCNI_mod,
  pty6CNI_mod, pty7CNI_mod), 
  compute_swb.cni_mods_lmer) 
```

Test for heteroskedasticity:
To test if the levels of SWB vary unequally across the range of CNI (homoscedasticity), White's test for heteroskedasticity is computed.

Advantages of bootstrapped White's test:
a) Robust to non-normality: Unlike some other tests, it does not assume normality of errors.
b) Flexible: It can detect various forms of heteroscedasticity.
c) Bootstrapping: This adds robustness to the test, especially for smaller sample sizes or when the data doesn not meet parametric assumptions.

White's test is a more general form of the Breusch-Pagan test. While Breusch-Pagan assumes heteroscedasticity is a linear function of the independent variables, White's test allows for non-linear forms.

```{r DONT-RUN-swb.cni_mods_heterosk, echo = T, eval = F}
 library(whitestrap)

compute_heterosk_swb.cni <- \(cni_mod){
  
  data <- coef(cni_mod)$pID %>%
  as.data.frame() %>%
  mutate(pID = rownames(.)) %>%
  select(-`(Intercept)`) %>% 
  separate(pID, into = c("pID", "country")) %>% 
  rename(CNI = z_ctry_response) %>% 
  full_join(data1)
  
  linear_lm <- lm(sc_swb.indv ~ CNI, data = data)
  
  linear_heterosk <- white_test_boot(linear_lm)
  
  quadratic_lm <- lm(sc_swb.indv ~ CNI + CNI^2, data = data)
  
  quadratic_heterosk <- white_test_boot(quadratic_lm)
  
  return(lst(linear_lm, linear_heterosk,  quadratic_lm, quadratic_heterosk))
  
}

all_swb.cni_mods_heterosk <- map(
  lst(mindsetCNI_mod, ismCNI_mod, globeCNI_mod,fantcCNI_mod,
  pty6CNI_mod, pty7CNI_mod), 
  
  compute_heterosk_swb.cni) 
```

```{r save-swb.cni_mods_heterosk, echo = F, eval = F}
save(all_swb.cni_mods_heterosk,
 file = here("objects/Study1/swb.cni_mods_heterosk.Rdata"))
```

```{r load-swb.cni_mods_heterosk, echo = F}
#takes a while to load
load(here("objects/Study1/swb.cni_mods_heterosk.Rdata"))

```

```{r fun.-tbl-swb.cni_heteroskt}
make_swb.cni_heterosk_tbl <- \(mod_name) {
  list(
    model = mod_name,
    
    w_stat_linear = all_swb.cni_mods_heterosk[[mod_name]]$linear_heterosk$w_stat,
    p_value_linear = all_swb.cni_mods_heterosk[[mod_name]]$linear_heterosk$p_value,
    w_stat_quadratic = all_swb.cni_mods_heterosk[[mod_name]]$quadratic_heterosk$w_stat,
    p_value_quadratic = all_swb.cni_mods_heterosk[[mod_name]]$quadratic_heterosk$p_value
  )
}

swb.cni_heterosk_tbl <- map_dfr(convert_to_char(mindsetCNI_mod, ismCNI_mod, globeCNI_mod,fantcCNI_mod,
  pty6CNI_mod, pty7CNI_mod), make_swb.cni_heterosk_tbl)
```

```{r tbl-swb.cni_heteroskt}
#|label: tbl-swb.cni_heteroskt

swb.cni_heterosk_tbl %>% 
  mutate(model=str_extract(model, "^[^CNI]+")) %>% 
  kable(booktabs = T,
        escape = F,
        format = "latex",
        col.names = c("Model", "W", "p", "W", "p")) %>%
  kable_styling() %>%
  add_header_above(c(" ", "Linear (b)" = 2, "Quadratic (b^2)" = 2)) %>% 
   footnote(general = paste0(
    "Linear model: sc_swb.indv CNI; ",
    "Quadratic model: sc_swb.indv CNI + CNI^2"), general_title = "Note:", title_format = "italic", 
    fixed_small_size = TRUE,
           footnote_as_chunk = FALSE,
           threeparttable = TRUE)

```

```{r echo=FALSE, eval=FALSE}
#when >.05 assumption of homoscedasticity(constant variance of residuals) is met. 
swb.cni_heterosk_tbl %>%
  mutate(across(starts_with("p_value"), 
                ~ifelse(. > 0.05, ">.05", as.character(.))))
```

@tbl-swb.cni_heteroskt reveals that the assumption of homoscedasticity is satisfied for the majority of the models under consideration. However, the Mindset and Isms CNI models exhibit evidence of heteroscedasticity, as indicated by their respective p-values (p < .05). Consequently, the findings pertaining to these two models should be interpreted with caution, as the violation of the homoscedasticity assumption may impact the reliability of the parameter estimates and statistical inferences drawn from these models. 


```{r fun.-heterosk_plot}
heterosk_plot <- \(model){ 
  
    plot_it <- \(data){
      data %>% 
  augment() %>%
sample_n(1000) %>%
ggplot(aes(x = CNI, y = .resid)) + 
    geom_jitter(alpha = .3,
height = .1, width = 0) + labs(x = "Est CNI",
       y = "Residual") +
     # xlim(-0.8, 1) +
     # ylim(-8, 10) + 
        theme_bw()}
  
    linear_plot <- all_swb.cni_mods_heterosk %>% 
  pluck(model, "linear_lm") %>%
  plot_it()
    
    quadratic_plot <- all_swb.cni_mods_heterosk %>% 
  pluck(model, "quadratic_lm") %>%
  plot_it()
    
   patch_plot <- linear_plot + quadratic_plot +
    plot_layout(axis_titles = "collect")+
   plot_annotation(tag_levels = list(c("Linear", "Quadratic"))) &  
  theme(
    plot.tag.position = c("top"),
    plot.caption = element_markdown(size = 12), 
    text = element_text("serif")
  )
    
return(patch_plot) }
```

```{r plot_swb-details}
plot_swb_details <- tibble(cni_type = c("mindset", "ism", "globe", "fantc", "pty6", "pty7")) %>% 
  mutate(cni_mod = paste0(cni_type, "CNI_mod"),
         caption = paste0("Association between ", cni_type, " CNI and Subjective Well-being at Individual level" ))
```

```{r plot-heteroskedasticity, echo=F}
#| fig-height: 4
#| fig-width: 10
#| out-width: "100%"
#| cap-location: bottom
#| fig-cap: 
#|   !expr plot_swb_details %>%
#|     pull(caption)

#retain models that have mindset moderators
plot_swb_details %>%
  pull(cni_mod) %>% 
  walk(~{
    cat("\n\n")  
    print(heterosk_plot(.x))
    cat("\n\n") 
  })
```


```{r fun.-plot_swb.cni}
plot_swb.cni <- \(model) {
  library(sjPlot)
  
  # Extract the formula from the model
  model_formula <- formula(model)
  
  # Check if the term CNI^2 is present in the formula
  is_quadratic <- grepl("CNI\\^2", deparse(model_formula))
  
  # Set the color based on the type of model
  if (is_quadratic) {
    plot_color <- "#E97140"
  } else {
    plot_color <- "#cc254f"
  }
  
  # Generate the plot
  plot_model(model, type = "pred", terms = c("CNI[all]"), colors = plot_color) +
    scale_y_continuous(limits = c(14, 20)) +
    scale_x_continuous(limits = c(-.4, 1)) +
    theme_bw()+
    labs(x = "CNI", y = "SWB")+
    theme(plot.title = element_blank())
}
  
all_swb.cni_plots <- map_depth(
  .x = all_swb.cni_mods,
  .depth = 2,
  .f = plot_swb.cni)

  
plot_swb.cni_patch <- \(model){
  plots <- all_swb.cni_plots%>% 
  pluck(model) %>% 
  set_names(c("li", "lc", "qi", "qc"))
  
  # title <- str_extract(model, "^[^_]+")
  
  plots$li + 
  plots$qi + 
 # plot_layout(axis_titles = "collect")+
  plot_annotation(
  #  title = title ,
      tag_levels = list(c("Linear", "Quadratic"))) &  
  theme(
    plot.tag.position = c("top"),
    plot.caption = element_markdown(size = 12), 
    text = element_text("serif")
  )
}
```



```{r plot_swb-walk, echo=F}
#| fig-height: 4
#| fig-width: 10
#| out-width: "100%"
#| cap-location: bottom
#| fig-cap: 
#|   !expr plot_swb_details %>%
#|     pull(caption)

#retain models that have mindset moderators
plot_swb_details %>%
  pull(cni_mod) %>% 
  walk(~{
    cat("\n\n")  
    print(plot_swb.cni_patch(.x))
    cat("\n\n") 
  })
```



